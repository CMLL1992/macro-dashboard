name: Daily Macro Jobs

on:
  schedule:
    # Actualizaci칩n completa: FRED + Correlaciones + Bias
    # Todos los d칤as a las 06:00 UTC (07:00 Madrid invierno, 08:00 verano)
    - cron: "0 6 * * *"
  workflow_dispatch: {}

jobs:
  bootstrap:
    runs-on: ubuntu-latest
    steps:
      - name: Ingest FRED
        run: |
          echo "游댃 Ingestando datos FRED..."
          curl -sS -X POST \
            -H "Authorization: Bearer $CRON_TOKEN" \
            "${APP_URL}/api/jobs/ingest/fred" | jq '{ok, updatedSeriesCount, errors_count: (.errors | length)}' || echo "Error en ingest FRED"
        env:
          CRON_TOKEN: ${{ secrets.CRON_TOKEN }}
          APP_URL: ${{ secrets.APP_URL }}

      - name: Ingest UK Indicators
        run: |
          echo "游댃 Ingestando indicadores UK (GBP)..."
          curl -sS -X POST \
            -H "Authorization: Bearer $CRON_TOKEN" \
            "${APP_URL}/api/jobs/ingest/uk" | jq '{success, ingested, errors}' || echo "丘멆잺 UK ingestion failed (non-critical)"
        env:
          CRON_TOKEN: ${{ secrets.CRON_TOKEN }}
          APP_URL: ${{ secrets.APP_URL }}

      - name: Ingest Japan Indicators
        run: |
          echo "游댃 Ingestando indicadores Jap칩n (JPY)..."
          curl -sS -X POST \
            -H "Authorization: Bearer $CRON_TOKEN" \
            "${APP_URL}/api/jobs/ingest/jp" | jq '{success, ingested, errors}' || echo "丘멆잺 Japan ingestion failed (non-critical)"
        env:
          CRON_TOKEN: ${{ secrets.CRON_TOKEN }}
          APP_URL: ${{ secrets.APP_URL }}

      - name: Correlations
        run: |
          echo "游댃 Calculando correlaciones..."
          curl -sS -X POST \
            -H "Authorization: Bearer $CRON_TOKEN" \
            "${APP_URL}/api/jobs/correlations" | jq '{ok, updatedPairsCount}' || echo "Error en correlations"
        env:
          CRON_TOKEN: ${{ secrets.CRON_TOKEN }}
          APP_URL: ${{ secrets.APP_URL }}

      - name: Compute Bias
        run: |
          echo "游댃 Calculando bias..."
          curl -sS -X POST \
            -H "Authorization: Bearer $CRON_TOKEN" \
            "${APP_URL}/api/jobs/compute/bias" | jq '{ok}' || echo "Error en bias"
        env:
          CRON_TOKEN: ${{ secrets.CRON_TOKEN }}
          APP_URL: ${{ secrets.APP_URL }}

      - name: Auto-ingest PMI from calendar
        run: |
          echo "游댃 Intentando ingesta autom치tica de PMI desde calendario..."
          curl -sS -X POST \
            -H "Authorization: Bearer $CRON_TOKEN" \
            "${APP_URL}/api/jobs/ingest/pmi" | jq '{success, ingested, skipped}' || echo "丘멆잺 PMI auto-ingest failed (non-critical)"
        env:
          CRON_TOKEN: ${{ secrets.CRON_TOKEN }}
          APP_URL: ${{ secrets.APP_URL }}

      - name: Update Calendar Events
        run: |
          echo "游늰 Actualizando calendario macroecon칩mico..."
          curl -sS -X POST \
            -H "Authorization: Bearer $CRON_TOKEN" \
            "${APP_URL}/api/jobs/calendar/update" | jq '{success, inserted, updated, total}' || echo "丘멆잺 Calendar update failed (non-critical)"
        env:
          CRON_TOKEN: ${{ secrets.CRON_TOKEN }}
          APP_URL: ${{ secrets.APP_URL }}


