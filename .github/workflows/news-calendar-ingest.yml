name: News & Calendar Ingest (All Sources)

# Pipeline autom√°tico para ingerir noticias y eventos del calendario econ√≥mico
# Desde m√∫ltiples fuentes: RSS, Forex Factory, FMP, Finnhub, Trading Economics, NewsAPI
# Se ejecuta autom√°ticamente cada 6 horas y puede ejecutarse manualmente

on:
  schedule:
    # Ejecutar cada 6 horas para verificar nuevas noticias y eventos
    - cron: "0 */6 * * *"
  workflow_dispatch: {}

jobs:
  ingest-all-sources:
    name: Ingest from All Sources
    runs-on: ubuntu-latest
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Install pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 10.20.0

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20'
          cache: 'pnpm'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Verify installation
        run: |
          echo "üîç Verificando instalaci√≥n..."
          pnpm --version
          node --version
          which tsx || echo "tsx no encontrado en PATH"
          pnpm list tsx || echo "tsx no instalado"

      - name: Debug environment
        run: |
          echo "üîç Verificando variables de entorno..."
          echo "APP_URL is set: $([ -n "$APP_URL" ] && echo 'YES' || echo 'NO')"
          echo "INGEST_KEY is set: $([ -n "$INGEST_KEY" ] && echo 'YES' || echo 'NO')"
          echo "FRED_API_KEY is set: $([ -n "$FRED_API_KEY" ] && echo 'YES' || echo 'NO')"
          echo "FMP_API_KEY is set: $([ -n "$FMP_API_KEY" ] && echo 'YES' || echo 'NO')"
          echo "FINNHUB_API_KEY is set: $([ -n "$FINNHUB_API_KEY" ] && echo 'YES' || echo 'NO')"
          echo "NEWSAPI_KEY is set: $([ -n "$NEWSAPI_KEY" ] && echo 'YES' || echo 'NO')"
          echo "TRADING_ECONOMICS_API_KEY is set: $([ -n "$TRADING_ECONOMICS_API_KEY" ] && echo 'YES' || echo 'NO')"
          if [ -n "$APP_URL" ]; then
            echo "APP_URL value: ${APP_URL:0:30}..." 
          fi
        env:
          APP_URL: ${{ secrets.APP_URL }}
          INGEST_KEY: ${{ secrets.INGEST_KEY }}
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
          FMP_API_KEY: ${{ secrets.FMP_API_KEY }}
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
          NEWSAPI_KEY: ${{ secrets.NEWSAPI_KEY }}
          TRADING_ECONOMICS_API_KEY: ${{ secrets.TRADING_ECONOMICS_API_KEY }}

      - name: Run all sources ingestion script
        run: |
          echo "üîÑ Ingestando desde TODAS las fuentes..."
          echo "APP_URL: ${APP_URL:0:50}..."
          echo "INGEST_KEY: ${INGEST_KEY:0:20}..."
          echo ""
          echo "Fuentes disponibles:"
          echo "  ‚úÖ RSS News (Bloomberg, Reuters, Financial Times)"
          echo "  ‚úÖ FRED Calendar"
          echo "  ‚úÖ Forex Factory Calendar"
          [ -n "$FMP_API_KEY" ] && echo "  ‚úÖ Financial Modeling Prep" || echo "  ‚è≠Ô∏è  Financial Modeling Prep (no API key)"
          [ -n "$FINNHUB_API_KEY" ] && echo "  ‚úÖ Finnhub" || echo "  ‚è≠Ô∏è  Finnhub (no API key)"
          [ -n "$NEWSAPI_KEY" ] && echo "  ‚úÖ NewsAPI" || echo "  ‚è≠Ô∏è  NewsAPI (no API key)"
          echo "  ‚úÖ Trading Economics (guest access)"
          echo ""
          pnpm exec tsx scripts/ingest-all-sources.ts 2>&1 || {
            echo "‚ùå Script fall√≥ con c√≥digo: $?"
            exit 1
          }
        env:
          APP_URL: ${{ secrets.APP_URL }}
          INGEST_KEY: ${{ secrets.INGEST_KEY }}
          FRED_API_KEY: ${{ secrets.FRED_API_KEY }}
          FMP_API_KEY: ${{ secrets.FMP_API_KEY }}
          FINNHUB_API_KEY: ${{ secrets.FINNHUB_API_KEY }}
          NEWSAPI_KEY: ${{ secrets.NEWSAPI_KEY }}
          TRADING_ECONOMICS_API_KEY: ${{ secrets.TRADING_ECONOMICS_API_KEY }}

      - name: Report results
        if: always()
        run: |
          echo "‚úÖ All sources ingestion job completed"
